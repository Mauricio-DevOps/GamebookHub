@model GamebookHub.Models.Gamebook
@using GamebookHub.Models
@{
    ViewData["Title"] = "Create";
    var existingAttrCount = Model?.CharacterSheet?.Attributes?.Count ?? 0;
}

<h1>Create</h1>
<h4>Gamebook</h4>
<hr />
<div class="row">
    <div class="col-md-8">
        <form asp-action="Create">
            <div asp-validation-summary="All" class="text-danger"></div>

            <!-- Metadados básicos (mantidos) -->
            <div class="form-group mb-3">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="Slug" class="control-label"></label>
                <input asp-for="Slug" class="form-control" />
                <span asp-validation-for="Slug" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="Description" class="control-label"></label>
                <input asp-for="Description" class="form-control" />
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="CoverUrl" class="control-label"></label>
                <input asp-for="CoverUrl" class="form-control" />
                <span asp-validation-for="CoverUrl" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="AuthorId" class="control-label"></label>
                <input asp-for="AuthorId" class="form-control" />
                <span asp-validation-for="AuthorId" class="text-danger"></span>
            </div>
            <div class="form-group mb-3">
                <label asp-for="PublishedAt" class="control-label"></label>
                <input asp-for="PublishedAt" class="form-control" type="datetime-local" />
                <span asp-validation-for="PublishedAt" class="text-danger"></span>
            </div>
            <div class="form-group form-check mb-4">
                <label class="form-check-label">
                    <input class="form-check-input" asp-for="IsPublished" /> @Html.DisplayNameFor(model => model.IsPublished)
                </label>
            </div>

            <!-- ============================  Ficha do Personagem  ============================ -->
            <div class="card mb-4">
                <div class="card-header">Ficha do Personagem</div>
                <div class="card-body">
                    <!-- Toggle principal -->
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input"
                               type="checkbox"
                               id="cs-enabled"
                               name="CharacterSheet.Enabled"
                               value="true"
                               @(Model?.CharacterSheet?.Enabled == true ? "checked" : "") />
                        <input type="hidden" name="CharacterSheet.Enabled" value="false" />

                        <label class="form-check-label" for="cs-enabled">Tem ficha?</label>
                    </div>


                    <div id="cs-block" style="display:@((Model?.CharacterSheet?.Enabled ?? false) ? "block" : "none")">
                        <!-- Atributos -->
                        <h5 class="mt-2">Atributos</h5>
                        <p class="text-muted">Defina atributos genéricos (ex.: Força, Defesa, Inteligência, HP...).</p>

                        <div id="attributes-list">
                            @if (Model?.CharacterSheet?.Attributes != null && Model.CharacterSheet.Attributes.Count > 0)
                            {
                                @for (var i = 0; i < Model.CharacterSheet.Attributes.Count; i++)
                                {
                                    var prefix = $"CharacterSheet.Attributes[{i}]";
                                    <div class="border rounded p-3 mb-3 attribute-item" data-index="@i">
                                        <!-- mantém estes dois -->
                                        <input type="hidden" name="CharacterSheet.Attributes.Index" value="@i" />
                                        <input type="hidden" name="@($"{prefix}.Id")" value="@Model.CharacterSheet.Attributes[i].Id" />

                                        <div class="row g-3">
                                            <!-- ... seus campos Label/Key/Tipo/Min/Max/Default/EnumOptions ... -->

                                            <div class="col-md-3 d-flex align-items-end">
                                                <div class="form-check">
                                                    <!-- checkbox PRIMEIRO -->
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           name="@($"{prefix}.Visible")"
                                                           value="true"
                                                           @(Model.CharacterSheet.Attributes[i].Visible ? "checked" : "") />
                                                    <!-- hidden DEPOIS -->
                                                    <input type="hidden" name="@($"{prefix}.Visible")" value="false" />
                                                    <label class="form-check-label">Visível</label>
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <label class="form-label">Ordem</label>
                                                <input class="form-control" type="number" name="@($"{prefix}.Order")" value="@Model.CharacterSheet.Attributes[i].Order" />
                                            </div>
                                        </div>

                                        <div class="mt-3 text-end">
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-attribute">Remover</button>
                                        </div>
                                    </div>
                                }


                            }
                        </div>

                        <button type="button" class="btn btn-outline-primary" id="add-attribute">Adicionar atributo</button>

                        <hr class="my-4" />

                        <!-- Inventário -->
                        <h5>Inventário</h5>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="inv-enabled"
                                   name="CharacterSheet.Inventory.Enabled"
                                   value="true"
                                   @(Model?.CharacterSheet?.Inventory?.Enabled == true ? "checked" : "") />
                            <input type="hidden" name="CharacterSheet.Inventory.Enabled" value="false" />
                            <label class="form-check-label" for="inv-enabled">Usa inventário?</label>
                        </div>

                        <div id="inv-block" style="display:@((Model?.CharacterSheet?.Inventory?.Enabled ?? false) ? "block" : "none")">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Modo</label>
                                    <select class="form-select" id="inv-mode" name="CharacterSheet.Inventory.Mode">
                                        @{
                                            var mode = Model?.CharacterSheet?.Inventory?.Mode.ToString() ?? "Unlimited";
                                        }
                                        <option value="Unlimited" selected="@(mode == "Unlimited")">Ilimitado</option>
                                        <option value="Slots" selected="@(mode == "Slots")">Por slots</option>
                                        <option value="Weight" selected="@(mode == "Weight")">Por peso/volume</option>
                                    </select>
                                </div>

                                <div class="col-md-3 inv-field inv-slots" style="display:@((Model?.CharacterSheet?.Inventory?.Mode == InventoryMode.Slots) ? "block" : "none")">
                                    <label class="form-label">Slots</label>
                                    <input class="form-control" type="number" min="1" name="CharacterSheet.Inventory.Slots" value="@(Model?.CharacterSheet?.Inventory?.Slots)" />
                                </div>

                                <div class="col-md-3 inv-field inv-capacity" style="display:@((Model?.CharacterSheet?.Inventory?.Mode == InventoryMode.Weight) ? "block" : "none")">
                                    <label class="form-label">Capacidade</label>
                                    <input class="form-control" type="number" step="0.01" min="0" name="CharacterSheet.Inventory.Capacity" value="@(Model?.CharacterSheet?.Inventory?.Capacity)" />
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <!-- ============================  /Ficha do Personagem  ============================ -->

            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-link">Back to List</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/js/gamebook-create.js" asp-append-version="true"></script>
}
